<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Linux 下搭建redis集群</title>
    <url>/2021/11/06/redis-cluster/</url>
    <content><![CDATA[<h1 id="Redis搭建集群"><a href="#Redis搭建集群" class="headerlink" title="Redis搭建集群"></a>Redis搭建集群</h1><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p> 新版的redis已经支持搭建集群了，不需要在用ruby插件，简单上手<br> 首先准备编译按章的前置环境并创建数据存储路径</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get install -y unzip build-essential tcl pkg-config &amp;&amp; apt-get autoremove -y</span><br><span class="line">useradd -m -s /usr/sbin/nologin redis</span><br><span class="line">mkdir -p /home/redis/data/7001 /home/redis/data/7002 /home/redis/data/7003 /home/redis/data/7004 /home/redis/data/7005 /home/redis/data/7006 /home/redis/log</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p> 编译安装redis,源文件可以直接在官网下载活着直接wget获取</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-- 解压</span><br><span class="line">unzip redis.zip -d redis</span><br><span class="line">tar -zxvf redis-5.0.14.tar.gz</span><br><span class="line">-- 编译安装</span><br><span class="line">cd redis &amp;&amp; make &amp;&amp; make test</span><br><span class="line">-- 配置脚本&amp;文件目录</span><br><span class="line">cp redis/src/redis-server redis/src/redis-cli redis/src/redis-sentinel redis/src/redis-benchmark redis/src/redis-check-rdb redis/src/redis-check-aof /usr/local/bin/</span><br><span class="line">mkdir -p /etc/redis/conf /var/redis</span><br></pre></td></tr></table></figure>

<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="批量设置配置文件-redis-conf-为redis默认配置文件"><a href="#批量设置配置文件-redis-conf-为redis默认配置文件" class="headerlink" title="批量设置配置文件,redis.conf 为redis默认配置文件"></a>批量设置配置文件,redis.conf 为redis默认配置文件</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cp redis.conf /etc/redis/conf/7001.conf</span><br><span class="line">cp redis.conf /etc/redis/conf/7002.conf</span><br><span class="line">cp redis.conf /etc/redis/conf/7003.conf</span><br><span class="line">cp redis.conf /etc/redis/conf/7004.conf</span><br><span class="line">cp redis.conf /etc/redis/conf/7005.conf</span><br><span class="line">cp redis.conf /etc/redis/conf/7006.conf</span><br><span class="line">sed -i &quot;s/6379/7001/&quot; /etc/redis/conf/7001.conf</span><br><span class="line">sed -i &quot;s/6379/7002/&quot; /etc/redis/conf/7002.conf</span><br><span class="line">sed -i &quot;s/6379/7003/&quot; /etc/redis/conf/7003.conf</span><br><span class="line">sed -i &quot;s/6379/7004/&quot; /etc/redis/conf/7004.conf</span><br><span class="line">sed -i &quot;s/6379/7005/&quot; /etc/redis/conf/7005.conf</span><br><span class="line">sed -i &quot;s/6379/7006/&quot; /etc/redis/conf/7006.conf</span><br></pre></td></tr></table></figure>

<h3 id="批量编辑各节点脚本"><a href="#批量编辑各节点脚本" class="headerlink" title="批量编辑各节点脚本"></a>批量编辑各节点脚本</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cp redis/utils/redis_init_script /etc/init.d/redis_7001</span><br><span class="line">cp redis/utils/redis_init_script /etc/init.d/redis_7002</span><br><span class="line">cp redis/utils/redis_init_script /etc/init.d/redis_7003</span><br><span class="line">cp redis/utils/redis_init_script /etc/init.d/redis_7004</span><br><span class="line">cp redis/utils/redis_init_script /etc/init.d/redis_7005</span><br><span class="line">cp redis/utils/redis_init_script /etc/init.d/redis_7006</span><br></pre></td></tr></table></figure>

<h3 id="配置启动项"><a href="#配置启动项" class="headerlink" title="配置启动项"></a>配置启动项</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sed -i -e &quot;s/6379/7001/&quot; -e &quot;s#CONF=\&quot;/etc/redis/\$&#123;REDISPORT&#125;\.conf\&quot;#CONF=\&quot;/etc/redis/conf/\$&#123;REDISPORT&#125;\.conf\&quot;#&quot; /etc/init.d/redis_7001</span><br><span class="line">sed -i -e &quot;s/6379/7002/&quot; -e &quot;s#CONF=\&quot;/etc/redis/\$&#123;REDISPORT&#125;\.conf\&quot;#CONF=\&quot;/etc/redis/conf/\$&#123;REDISPORT&#125;\.conf\&quot;#&quot; /etc/init.d/redis_7002</span><br><span class="line">sed -i -e &quot;s/6379/7003/&quot; -e &quot;s#CONF=\&quot;/etc/redis/\$&#123;REDISPORT&#125;\.conf\&quot;#CONF=\&quot;/etc/redis/conf/\$&#123;REDISPORT&#125;\.conf\&quot;#&quot; /etc/init.d/redis_7003</span><br><span class="line">sed -i -e &quot;s/6379/7004/&quot; -e &quot;s#CONF=\&quot;/etc/redis/\$&#123;REDISPORT&#125;\.conf\&quot;#CONF=\&quot;/etc/redis/conf/\$&#123;REDISPORT&#125;\.conf\&quot;#&quot; /etc/init.d/redis_7004</span><br><span class="line">sed -i -e &quot;s/6379/7005/&quot; -e &quot;s#CONF=\&quot;/etc/redis/\$&#123;REDISPORT&#125;\.conf\&quot;#CONF=\&quot;/etc/redis/conf/\$&#123;REDISPORT&#125;\.conf\&quot;#&quot; /etc/init.d/redis_7005</span><br><span class="line">sed -i -e &quot;s/6379/7006/&quot; -e &quot;s#CONF=\&quot;/etc/redis/\$&#123;REDISPORT&#125;\.conf\&quot;#CONF=\&quot;/etc/redis/conf/\$&#123;REDISPORT&#125;\.conf\&quot;#&quot; /etc/init.d/redis_7006</span><br><span class="line"></span><br><span class="line">update-rc.d redis_7001 defaults</span><br><span class="line">update-rc.d redis_7002 defaults</span><br><span class="line">update-rc.d redis_7003 defaults</span><br><span class="line">update-rc.d redis_7004 defaults</span><br><span class="line">update-rc.d redis_7005 defaults</span><br><span class="line">update-rc.d redis_7006 defaults</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sed -i -e &quot;/^# masterauth/a masterauth passwd&quot; -e &quot;/^# requirepass/a requirepass passwd&quot; /etc/redis/conf/7001.conf</span><br><span class="line">sed -i -e &quot;/^# masterauth/a masterauth passwd&quot; -e &quot;/^# requirepass/a requirepass passwd&quot; /etc/redis/conf/7002.conf</span><br><span class="line">sed -i -e &quot;/^# masterauth/a masterauth passwd&quot; -e &quot;/^# requirepass/a requirepass passwd&quot; /etc/redis/conf/7003.conf</span><br><span class="line">sed -i -e &quot;/^# masterauth/a masterauth passwd&quot; -e &quot;/^# requirepass/a requirepass passwd&quot; /etc/redis/conf/7004.conf</span><br><span class="line">sed -i -e &quot;/^# masterauth/a masterauth passwd&quot; -e &quot;/^# requirepass/a requirepass passwd&quot; /etc/redis/conf/7005.conf</span><br><span class="line">sed -i -e &quot;/^# masterauth/a masterauth passwd&quot; -e &quot;/^# requirepass/a requirepass passwd&quot; /etc/redis/conf/7006.conf</span><br></pre></td></tr></table></figure>

<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><h3 id="启动各节点"><a href="#启动各节点" class="headerlink" title="启动各节点"></a>启动各节点</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/etc/init.d/redis_7001 start</span><br><span class="line">/etc/init.d/redis_7002 start</span><br><span class="line">/etc/init.d/redis_7003 start</span><br><span class="line">/etc/init.d/redis_7004 start</span><br><span class="line">/etc/init.d/redis_7005 start</span><br><span class="line">/etc/init.d/redis_7006 start</span><br></pre></td></tr></table></figure>

<h3 id="创建节点"><a href="#创建节点" class="headerlink" title="创建节点"></a>创建节点</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">edis-cli --cluster  create \</span><br><span class="line">              127.0.0.1:7003 127.0.0.1:7001 127.0.0.1:7002 \</span><br><span class="line">              127.0.0.1:7004 127.0.0.1:7005 127.0.0.1:7006 \</span><br><span class="line">              --cluster-replicas 1  -a &quot;passwd&quot;</span><br></pre></td></tr></table></figure>

<h2 id="默认配置文件示例"><a href="#默认配置文件示例" class="headerlink" title="默认配置文件示例"></a>默认配置文件示例</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">protected-mode yes</span><br><span class="line">port 6379</span><br><span class="line">tcp-backlog 511</span><br><span class="line">timeout 0</span><br><span class="line">tcp-keepalive 300</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /var/run/redis_6379.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile /home/redis/log/6379.log</span><br><span class="line">databases 16</span><br><span class="line">always-show-logo no</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">set-proc-title <span class="built_in">yes</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">proc-title-template <span class="string">&quot;&#123;title&#125; &#123;listen-addr&#125; &#123;server-mode&#125;&quot;</span></span></span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rdb-del-sync-files no</span></span><br><span class="line">dir /home/redis/data/6379</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">masterauth</span></span><br><span class="line">replica-serve-stale-data yes</span><br><span class="line">replica-read-only yes</span><br><span class="line">repl-diskless-sync no</span><br><span class="line">repl-diskless-sync-delay 5</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">repl-diskless-load disabled</span></span><br><span class="line">repl-disable-tcp-nodelay no</span><br><span class="line">replica-priority 100</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">acllog-max-len 128</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">requirepass</span></span><br><span class="line">lazyfree-lazy-eviction no</span><br><span class="line">lazyfree-lazy-expire no</span><br><span class="line">lazyfree-lazy-server-del no</span><br><span class="line">replica-lazy-flush no</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">lazyfree-lazy-user-del no</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">lazyfree-lazy-user-flush no</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">oom-score-adj no</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">oom-score-adj-values 0 200 800</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">disable-thp <span class="built_in">yes</span></span></span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename &quot;appendonly.aof&quot;</span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line">aof-use-rdb-preamble yes</span><br><span class="line">lua-time-limit 5000</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file /home/redis/data/6379/nodes-6379.conf</span><br><span class="line">cluster-node-timeout 15000</span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line">slowlog-max-len 128</span><br><span class="line">latency-monitor-threshold 0</span><br><span class="line">notify-keyspace-events &quot;&quot;</span><br><span class="line">hash-max-ziplist-entries 512</span><br><span class="line">hash-max-ziplist-value 64</span><br><span class="line">list-max-ziplist-size -2</span><br><span class="line">list-compress-depth 0</span><br><span class="line">set-max-intset-entries 512</span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line">hll-sparse-max-bytes 3000</span><br><span class="line">stream-node-max-bytes 4096</span><br><span class="line">stream-node-max-entries 100</span><br><span class="line">activerehashing yes</span><br><span class="line">client-output-buffer-limit normal 0 0 0</span><br><span class="line">client-output-buffer-limit replica 256mb 64mb 60</span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60</span><br><span class="line">hz 10</span><br><span class="line">dynamic-hz yes</span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br><span class="line">rdb-save-incremental-fsync yes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">jemalloc-bg-thread <span class="built_in">yes</span></span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>技术笔记</category>
      </categories>
      <tags>
        <tag>redis</tag>
        <tag>database</tag>
      </tags>
  </entry>
</search>
